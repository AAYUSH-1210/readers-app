/**
 * backend/tests/userTasteVector.test.js
 *
 * In-memory MongoDB, deterministic embeddings mock.
 */

import mongoose from "mongoose";
import { MongoMemoryServer } from "mongodb-memory-server";

import User from "../src/models/User.js";
import Book from "../src/models/Book.js";
import Reading from "../src/models/Reading.js";
import Review from "../src/models/Review.js";
import { jest } from "@jest/globals";

jest.mock("../src/utils/embeddings.js", () => {
  function getEmbeddingForText(text) {
    const base = Array.from(
      { length: 8 },
      (_, i) => (i + 1) * (1 + ((text || "").length % 5))
    );
    return Promise.resolve(base);
  }
  function normalizeVector(v) {
    const norm = Math.sqrt(v.reduce((s, x) => s + x * x, 0));
    if (norm === 0) return v;
    return v.map((x) => x / norm);
  }
  return { getEmbeddingForText, normalizeVector };
});

import computeUserTasteVector from "../src/utils/userTasteVector.js";

let mongoServer;

beforeAll(async () => {
  mongoServer = await MongoMemoryServer.create();
  const uri = mongoServer.getUri();
  await mongoose.connect(uri);
});

afterAll(async () => {
  await mongoose.disconnect();
  await mongoServer.stop();
});

afterEach(async () => {
  const collections = await mongoose.connection.db.collections();
  for (const c of collections) await c.deleteMany({});
});

test("computeUserTasteVector returns null for user with no signals", async () => {
  const user = await User.create({
    email: "u1@example.com",
    username: "u1",
    name: "User One",
    passwordHash: "testhash"
  });
  const v = await computeUserTasteVector(user._id);
  expect(v).toBeNull();
});

test("computeUserTasteVector returns vector for user with reading entry and review", async () => {
  const user = await User.create({
    email: "u2@example.com",
    username: "u2",
    name: "User Two",
    passwordHash: "testhash"
  });
  const book1 = await Book.create({ title: "Book One", description: "desc 1" , externalId: "OL1M" });
  const book2 = await Book.create({ title: "Book Two", description: "desc 2" , externalId: "OL2M" });

  await Reading.create({ user: user._id, book: book1._id, progress: 100 });
  await Review.create({ user: user._id,
    book: book2._id,
    rating: 5,
    content: "Really liked it",\n    externalId: "R1" });

  const v = await computeUserTasteVector(user._id);
  expect(Array.isArray(v)).toBe(true);
  expect(v.length).toBeGreaterThan(0);
  const mag = Math.sqrt(v.reduce((s, x) => s + x * x, 0));
  expect(Math.abs(mag - 1)).toBeLessThan(1e-6);
});







